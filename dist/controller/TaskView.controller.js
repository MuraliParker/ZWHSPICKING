$.sap.require("com.sap.parker.zwmpicking.utils.Formatter");sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageBox"],function(e,t,i){"use strict";return e.extend("com.sap.parker.zwmpicking.controller.TaskView",{onInit:function(){this.wareHouseNumber="";this.resourceGrp="";this.handlerNumber="";this.inputFlag=false;this.exceptionFlag=false;this.batchNumbers=[];this.serialNumbers=[];this.itemData=this.getOwnerComponent().getModel("WarehouseTaskModel").getData();this.serialNumbersResults=[];this.batchNumberResults=[];this.oDataModel=this.getOwnerComponent().getModel();var e=sap.ui.core.UIComponent.getRouterFor(this);e.getRoute("TaskView").attachPatternMatched(this._onObjectMatched,this)},_onObjectMatched:function(e){this.batchNumbers=[];this.serialNumbers=[];this.itemData=this.getOwnerComponent().getModel("WarehouseTaskModel").getData()},getWarehouseTaskData:function(e,i,a){var s=this;this.oDataModel.read("/ConfirmWarehouseTaskSet",{urlParameters:{$filter:"Lgnum eq '"+e+"' and Queue eq '"+a+"' and Prsrc eq '"+i+"'",$expand:"CWTtoSer"},success:function(e){console.log(e);var i=new t;i.setData(e.results[0]);s.itemData=e.results[0];s.getView().byId("warehouseHdrForm").setModel(i,"WarehouseTaskModel");s.getView().byId("warehouseDetailForm").setModel(i,"WarehouseTaskModel")},error:function(e){console.log(e)}})},validateInput:function(){var e=this.getView();this.setSourceBin=false;this.setScanPart=false;this.setActualQty=false;this.setScanDestBin=false;if(e.byId("inpScanSourceBin").getValue()!=e.byId("inpSourceBin").getValue()){this.setSourceBin=true}if(e.byId("inpScanPart").getValue()!=e.byId("inpPart").getValue()){this.setScanPart=true}if(parseFloat(e.byId("inpActualQty").getValue()).toFixed(3)!=parseFloat(e.byId("inpTargetQty").getValue()).toFixed(3)){this.setActualQty=true}if(e.byId("inpDestinationBin").getValue().length>0){if(e.byId("inpScanDestinationBin").getValue()!=e.byId("inpDestinationBin").getValue()){this.setScanDestBin=true}}},enableExecbtn:function(e){if(e.getSource().getId().indexOf("inpActualQty")>=0){var t=parseFloat(this.getView().byId("inpTargetQty").getValue()).toFixed(3);var i=parseFloat(this.getView().byId("inpActualQty").getValue()).toFixed(3);var a=(parseFloat(t)-parseFloat(i)).toFixed(3);this.getView().byId("inpQtyDifference").setValue(a);if(parseInt(this.getView().byId("inpActualQty").getValue())>0){if(this.itemData.Sernp.length>0){this.getView().byId("scanAddSerialBtn").setEnabled(true);sap.m.MessageToast.show("Kindly Add Serial Number Number")}if(this.itemData.Xchpf==="X"){this.getView().byId("scanAddBatchBtn").setEnabled(true);sap.m.MessageToast.show("Kindly Add Batch Number Number")}}}if(e.getSource().getId().indexOf("inpScanPart")>=0){var s=e.getParameter("value");if(s[0]==="p"||s[0]==="P"){this.getView().byId("inpScanPart").setValue(s.substring(1))}}this.validateInput();if(!this.setSourceBin&&!this.setScanPart&&!this.setActualQty&&!this.setScanDestBin){this.inputFlag=false}else{this.inputFlag=true}if(this.inputFlag){if(this.exceptionFlag){this.getView().byId("execbtn").setEnabled(true)}else{this.getView().byId("execbtn").setEnabled(false)}}else if(!this.inputFlag&&!this.exceptionFlag){this.getView().byId("execbtn").setEnabled(true)}else if(this.exceptionFlag){this.getView().byId("execbtn").setEnabled(true)}else{this.getView().byId("execbtn").setEnabled(false)}},onPressBatchNumber:function(){this.getActualQty=parseInt(this.getView().byId("inpActualQty").getValue());this._addBatchNumberDialog=null;this._addBatchNumberDialog=sap.ui.xmlfragment("com.sap.parker.zwmpicking.view.AddBatchNumber",this);for(var e=1;e<this.getActualQty;e++){this.handleAddWorkOrder("idBatchNumber")}var t=sap.ui.getCore().byId("idBatchNumber").getItems();if(this.batchNumbers.length>0){for(var e=0;e<this.batchNumbers.length;e++){t[e].getAggregation("cells")[0].setProperty("value",this.batchNumbers[e])}}this._addBatchNumberDialog.open()},onPressSerialNumber:function(){this.getActualQty=parseInt(this.getView().byId("inpActualQty").getValue());this._addSerialNumberDialog=null;this._addSerialNumberDialog=sap.ui.xmlfragment("com.sap.parker.zwmpicking.view.AddSerialNumber",this);for(var e=1;e<this.getActualQty;e++){this.handleAddWorkOrder("idSerNumber")}var t=sap.ui.getCore().byId("idSerNumber").getItems();if(this.serialNumbers.length>0){for(var e=0;e<this.serialNumbers.length;e++){t[e].getAggregation("cells")[0].setProperty("value",this.serialNumbers[e])}}this._addSerialNumberDialog.open()},handleAddWorkOrder:function(e){var t=new sap.m.ColumnListItem({type:sap.m.ListType.Inactive,cells:[new sap.m.Input({value:""})]});sap.ui.getCore().byId(e).addItem(t)},onPressBatchOkButton:function(){if(this._addBatchNumberDialog){this._addBatchNumberDialog.destroy(true);this._addBatchNumberDialog=null}},onPressBatchCancelButton:function(){if(this._addBatchNumberDialog){this._addBatchNumberDialog.destroy(true);this._addBatchNumberDialog=null}},onBatchValidateButton:function(){var e=this;this.batchNumbers=[];var t=sap.ui.getCore().byId("idBatchNumber").getItems();for(var i=0;i<t.length;i++){this.batchNumbers.push(t[i].getAggregation("cells")[0].getProperty("value"))}this.prepareSerValPayload("Batch");this.oDataModel.create("/ConfirmWarehouseTaskSet",this.reqSerNumbersPayload,{success:function(t){console.log(t);e.checkBatchIdValid=[];if(t.CWTtoBat.results.length>0){for(var i=0;i<t.CWTtoBat.results.length;i++){e.checkBatchIdValid.push(t.CWTtoBat.results[i].Valid)}}e.showValidateResultsBatchId(e.checkBatchIdValid)},error:function(e){console.log(e)}})},onSerValidateButton:function(){var e=this;this.serialNumbers=[];var t=sap.ui.getCore().byId("idSerNumber").getItems();for(var i=0;i<t.length;i++){this.serialNumbers.push(t[i].getAggregation("cells")[0].getProperty("value"))}this.prepareSerValPayload("Serial");this.oDataModel.create("/ConfirmWarehouseTaskSet",this.reqSerNumbersPayload,{success:function(t){console.log(t);e.checkSerialNumberValid=[];if(t.CWTtoSer.results.length>0){for(var i=0;i<t.CWTtoSer.results.length;i++){e.checkSerialNumberValid.push(t.CWTtoSer.results[i].Valid)}}e.showValidateResultsSrNumber(e.checkSerialNumberValid)},error:function(e){console.log(e)}})},showValidateResultsBatchId:function(e){var t=sap.ui.getCore().byId("idBatchNumber").getItems();var i=true;for(var a=0;a<t.length;a++){if(e[a]=="I"){t[a].getAggregation("cells")[0].setValueState("Error");t[a].getAggregation("cells")[0].setValueStateText("Invalid Batch Id")}else{t[a].getAggregation("cells")[0].setValueState("Success");t[a].getAggregation("cells")[0].setValueStateText("")}}for(var s=0;s<e.length;s++){if(e[s]=="I"){i=false;break}}if(i){sap.ui.getCore().byId("idBatchNumber").getParent().getEndButton().setEnabled(true)}},showValidateResultsSrNumber:function(e){var t=sap.ui.getCore().byId("idSerNumber").getItems();var i=true;for(var a=0;a<t.length;a++){if(e[a]=="I"){t[a].getAggregation("cells")[0].setValueState("Error");t[a].getAggregation("cells")[0].setValueStateText("Invalid Serial Number")}else{t[a].getAggregation("cells")[0].setValueState("Success");t[a].getAggregation("cells")[0].setValueStateText("")}}for(var s=0;s<e.length;s++){if(e[s]=="I"){i=false;break}}if(i){sap.ui.getCore().byId("idSerNumber").getParent().getEndButton().setEnabled(true)}},prepareSerValPayload:function(e){this.serialNumbersResults=[];this.batchNumberResults=[];if(this.serialNumbers.length>0){for(var t=0;t<this.serialNumbers.length;t++){this.serialNumbersResults.push({Serid:this.serialNumbers[t]})}}if(this.batchNumbers.length>0){for(var t=0;t<this.batchNumbers.length;t++){this.batchNumberResults.push({Batchid:this.batchNumbers[t]})}}var i,a;if(this.getView().byId("inpActualQty").getValue()===""){i="0.000"}else{i=this.getView().byId("inpActualQty").getValue()}if(this.getView().byId("inpQtyDifference").getValue()===""){a="0.000"}else{a=this.getView().byId("inpQtyDifference").getValue()}this.reqSerNumbersPayload={Lgnum:this.itemData.Lgnum,Queue:this.itemData.Queue,Prsrc:this.itemData.Prsrc,Vltyp:this.itemData.Vltyp,Nltyp:this.itemData.Nltyp,Who:this.itemData.Who,Tanum:this.itemData.Tanum,Papos:"0000",Squit:false,Vlpla:this.getView().byId("inpSourceBin").getValue(),Svlpla:this.getView().byId("inpScanSourceBin").getValue(),Matid:this.getView().byId("inpPart").getValue(),Smatid:this.getView().byId("inpScanPart").getValue(),Maktx:this.itemData.Maktx,Vsolm:this.getView().byId("inpTargetQty").getValue(),Meins:this.getView().byId("uom").getText(),Nista:i,Ndifa:a,Batchid:this.itemData.Batchid,Sbatchid:"",Nlpla:this.getView().byId("inpDestinationBin").getValue(),Snlpla:this.getView().byId("inpScanDestinationBin").getValue(),Chksernum:"",Chkbatch:"",Sernp:"",Xchpf:"",Rdocid:this.itemData.Rdocid,Ritmid:this.itemData.Ritmid,Rdoccat:this.itemData.Rdoccat,CWTtoSer:this.serialNumbersResults,CWTtoExc:[],CWTtoRet:[],CWTtoBat:this.batchNumberResults};if(e==="Batch"){this.reqSerNumbersPayload.Chksernum="";this.reqSerNumbersPayload.Chkbatch="X"}if(e==="Serial"){this.reqSerNumbersPayload.Chksernum="X";this.reqSerNumbersPayload.Chkbatch=""}},onPressCancelButton:function(){if(this._addSerialNumberDialog){this._addSerialNumberDialog.destroy(true);this._addSerialNumberDialog=null}},onCloseSerValidateButton:function(){if(this._addSerialNumberDialog){this._addSerialNumberDialog.destroy(true);this._addSerialNumberDialog=null}},onException:function(){var e=this;this._dialogTable=null;this._dialogTable=sap.ui.xmlfragment("com.sap.parker.zwmpicking.view.Exception",this);this.getView().addDependent(this._dialogTable);this.oDataModel.read("/ExceptionList1Set",{urlParameters:{$filter:"Lgnum eq '"+this.itemData.Lgnum+"'"},success:function(i){console.log(i);var a=new t;a.setData({ExceptionModelSet:i.results});sap.ui.getCore().byId("exceptionTable").setModel(a,"ExceptionModel");e._dialogTable.open()},error:function(e){console.log(e)}})},onChangeQueue:function(){this.getOwnerComponent().getRouter().navTo("RouteMainView")},onPressOkButton:function(e){this.exceptionCode=[];this.busnContext=[];this.prmCode=[];if(sap.ui.getCore().byId("exceptionTable").getSelectedItems().length>0){this.exceptionFlag=true;var t=sap.ui.getCore().byId("exceptionTable").getSelectedItems().length;var i=sap.ui.getCore().byId("exceptionTable").getSelectedItems();for(var a=0;a<t;a++){this.exceptionCode.push(i[a].getAggregation("cells")[0].getProperty("text"));this.busnContext.push(i[a].getAggregation("cells")[2].getProperty("text"));this.prmCode.push(i[a].getAggregation("cells")[3].getProperty("text"))}}else{this.exceptionFlag=false}if(this._dialogTable){this._dialogTable.destroy(true);this._dialogTable=null}this.enableExecbtn(e)},onExecutePress:function(){var e=this;this.onexecuteConfirmTask()},preparePayload:function(){var e=this;var t="";if(this.getView().byId("printFlagCheckBox").getSelected()){t="X"}this.exceptionResults=[];this.SerialNumber=[];this.SerialNumber.push({Tanum:this.itemData.Tanum,Lscheck:false,Papos:"0000",Serid:""});if(this.exceptionCode===undefined){}else{if(this.exceptionCode.length>0){for(var i=0;i<this.exceptionCode.length;i++){this.exceptionResults.push({Tanum:this.itemData.Tanum,Papos:"0000",Exccode:this.exceptionCode[i],Buscon:this.busnContext[i],Prmode:this.prmCode[i]})}}}var a,s;if(this.getView().byId("inpActualQty").getValue()===""){a="0.000"}else{a=this.getView().byId("inpActualQty").getValue()}if(this.getView().byId("inpQtyDifference").getValue()===""){s="0.000"}else{s=this.getView().byId("inpQtyDifference").getValue()}this.requestBody={Lgnum:this.itemData.Lgnum,Queue:this.itemData.Queue,Prsrc:this.itemData.Prsrc,Vltyp:this.itemData.Vltyp,Nltyp:this.itemData.Nltyp,Who:this.itemData.Who,Tanum:this.itemData.Tanum,Papos:"0000",Squit:false,Vlpla:this.getView().byId("inpSourceBin").getValue(),Svlpla:this.getView().byId("inpScanSourceBin").getValue(),Matid:this.getView().byId("inpPart").getValue(),Smatid:this.getView().byId("inpScanPart").getValue(),Maktx:this.itemData.Maktx,Vsolm:this.getView().byId("inpTargetQty").getValue(),Meins:this.getView().byId("uom").getText(),Nista:a,Ndifa:s,Batchid:this.itemData.Batchid,Sbatchid:"",Nlpla:this.getView().byId("inpDestinationBin").getValue(),Snlpla:this.getView().byId("inpScanDestinationBin").getValue(),Sernp:"",Xchpf:"",Chksernum:"",Chkbatch:"",Rdocid:this.itemData.Rdocid,Ritmid:this.itemData.Ritmid,Rdoccat:this.itemData.Rdoccat,CWTtoSer:this.serialNumbersResults,CWTtoExc:this.exceptionResults,CWTtoRet:[],CWTtoBat:this.batchNumberResults,HUList:this.HUList,PrintHUList:t}},fetchNextTask:function(e,a,s,r){var n=this;this.oDataModel.read("/ConfirmWarehouseTaskSet",{urlParameters:{$filter:"Lgnum eq '"+e+"' and Queue eq '"+a+"' and Prsrc eq '"+s+"' and Who eq '"+r+"'",$expand:"CWTtoSer"},success:function(e){console.log(e);n.exceptionCode=[];n.getView().byId("printFlagCheckBox").setSelected(false);if(e.results.length>0){var a=new t;a.setData(e.results[0]);n.itemData=e.results[0];n.getOwnerComponent().setModel(a,"WarehouseTaskModel")}else{i.information("No WareHouse Task Found");n.getOwnerComponent().getRouter().navTo("RouteMainView")}},error:function(e){i.error("Error while fetching Warehouse Task");console.log(e)}})},onPressCreatePickHU:function(){var e=this;var t=this.getView().byId("inpScanDestinationBin").getValue();var a=this.getView().byId("inpActualQty").getValue();this.createPickHU=null;this.createPickHU=sap.ui.xmlfragment("com.sap.parker.zwmpicking.view.CreatePickHU",this);if(t.length>0&&a.length>0&&parseInt(a)>0){this.getView().addDependent(this.createPickHU);this.createPickHU.open()}else{i.alert(" Destination and Quantity should be filled")}},onPressBackButton:function(){this.createPickHU.close()},onPressCreateHU:function(e){var t=this;this.HUList="";var a;if(this.getView().byId("inpActualQty").getValue()===""){a="0.000"}else{a=this.getView().byId("inpActualQty").getValue()}this.dataPayload={Lgnum:this.itemData.Lgnum,Who:this.itemData.Who,Tanum:this.itemData.Tanum,Nista:a,Meins:this.getView().byId("uom").getText(),HQty:this.boxNumber,Snlpla:this.getView().byId("inpScanDestinationBin").getValue(),Prsrc:this.itemData.Prsrc,Matid:this.getView().byId("inpPart").getValue(),HUList:""};this.oDataModel.create("/PickHUSet",this.dataPayload,{success:function(e){sap.m.MessageToast.show("HU Created Successfully");t.HUList=e.HUList;t.createPickHU.close()},error:function(e){i.error(JSON.parse(e.responseText).error.message.value)}})},onEnterBoxesInput:function(e){var t=this;this.boxNumber=e.getParameter("value");if(parseInt(this.boxNumber)>parseInt(this.getView().byId("inpActualQty").getValue())){i.error("Boxes Quantity should not be more than Actual Quantity");e.getSource().getParent().getEndButton().setEnabled(false)}else{e.getSource().getParent().getEndButton().setEnabled(true)}},onexecuteConfirmTask:function(){var e=this;this.preparePayload();this.oDataModel.create("/ConfirmWarehouseTaskSet",this.requestBody,{success:function(t){console.log(t);var a;if(e.getView().byId("printFlagCheckBox").getSelected()){a="Task Confirmed and Printed Successfully "}else{a="Task Confirmed Successfully "}i.information(a,{action:[i.Action.OK],onClose:function(t){e.fetchNextTask(e.itemData.Lgnum,e.itemData.Queue,e.itemData.Prsrc,e.itemData.Who)}})},error:function(e){console.log(e);i.error(JSON.parse(e.responseText).error.message.value,{action:[i.Action.OK,i.Action.CLOSE],onClose:function(e){}})}})}})});